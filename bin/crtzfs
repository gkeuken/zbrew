#!/bin/sh
crt() {
	vsamds=$1
	zfs=$2
	size=$*
	mkdir -p -m 755 "${zfs}"
	rc=$?
	if [ $rc -gt 0 ]; then
		exit $rc
	fi

	out=`mvscmdauth --pgm=IDCAMS --sysprint='*' --sysin=stdin <<zzz
   DEFINE CLUSTER(NAME(${vsamds}) -
   LINEAR ${size} SHAREOPTIONS(3)
zzz`
   	rc=$?
	if [ $rc -gt 0 ]; then
		echo "${out}" >&2
		exit $rc
	fi
	out=`mvscmdauth --pgm=IOEAGFMT --args="-aggregate ${vsamds} -compat" --sysprint='*'`
	rc=$?
	if [ $rc -gt 0 ]; then
		echo "${out}" >&2
		exit $rc
	fi
	/usr/sbin/mount -t zfs -f ${vsamds} "${zfs}"
	rc=$?
	if [ $rc -gt 0 ]; then
		exit $rc
	fi
	exit 0
}

if [ $# != 3 ]; then
	echo "crtzfs <vsamds> <zfs> <size>" >&2
	echo "Example:" >&2
	echo "  crtzfs IBMUSER.ZFS /my/zfs 'CYLINDER(1 1)'" >&2
	exit 4
fi
crt $*
