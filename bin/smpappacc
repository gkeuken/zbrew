#!/bin/sh

. zbrewfuncs
InvalidOption=1
TooFewParms=2
UnknownAction=3

#
# Temporary hack - replace with a proper message file
#
msg() {
	pgm=$1
	msgnum=$2
	msgtype=$3
	
	shift 3
	args=$*

	case ${msgnum} in 
		${InvalidOption}) msgtext="Invalid option specified: -";;
		${TooFewParms}) msgtext="Too few Parameters specified. Expected 2 but received: ";;
		${UnknownAction}) msgtext="Unknown action specified: ";;
		*) msgtext="Internal Error. Unknow msgnum: ${msgnum}";;
	esac
	echo "ZCL000"${msgnum}${msgtype} "${msgtext}${args}" >&2
}

#
# Temporary hack - replace with a manpage
#
syntax() {
	echo "\
smpappacc [-vd] <prefix> <fmid list>
	    
Examples:
	smpappacc apply igy630 HADB630 JADB63H JADB631 JADB632 <-- Perform SMP/APPLY on previously RECEIVEed product IGY630
	smpappacc accept igy630 HADB630 JADB63H JADB631 JADB632 <-- Perform SMP/ACCEPT on previously RECEIVEed product IGY630
" >&2 
	exit 16
}

runapply() {
	
	smpfunc="$1"
	check="$2"
	sw="$3"
	fmids="$4"
	tmpCntlHFS=${ZBREW_TMP}/$$.${check}.cntl.xml

	if [ "${smpfunc}" = "APPLY" ]; then
		echo "  SET BDY(${sw}T)." >${tmpCntlHFS}
	else
		echo "  SET BDY(${sw}D)." >${tmpCntlHFS}
	fi
	echo "  ${smpfunc} SELECT(" >>${tmpCntlHFS}
	for fmid in $fmids; do
		echo "    ${fmid}" >>${tmpCntlHFS}
	done
	echo "  )" >>${tmpCntlHFS}
	if [ "${ALLPTFS}" = '1' ]; then
		echo "  FORFMID(" >>${tmpCntlHFS}
		for fmid in $fmids; do
			echo "    ${fmid}" >>${tmpCntlHFS}
		done
		echo "  )" >>${tmpCntlHFS}
	fi
	echo "  GROUPEXTEND(NOAPARS,NOUSERMODS)" >>${tmpCntlHFS}
	if [ "${check}" = "CHECK" ]; then
		echo "  CHECK" >>${tmpCntlHFS}
	fi
	echo "  RETRY(YES)" >>${tmpCntlHFS}
	echo "  BYPASS(HOLDSYSTEM,HOLDUSER,HOLDCLASS(HIPER))." >>${tmpCntlHFS}
	
	smprpt="${ZBREW_TMP}/$$.smprpt"
	smpsysprint="${ZBREW_TMP}/$$.sysprint"
	
	smpout=`smp -w ${ZBREW_TMP} -r "${smprpt}" -p "${smpsysprint}" -i ${ZBREW_HLQ}${sw}G.GLOBAL.CSI <${tmpCntlHFS}`
	rc=$?
	rm "${tmpCntlHFS}"
	if [ $rc -gt 0 ] || [ $verbose -gt 0 ]; then
		echo "${smpout}"
	else
		rm "${smprpt}"
		rm "${smpsysprint}"
	fi
	
        return ${rc}
} 

apply() {
	sw=$3
	
	if [ ${check} = "CHECK" ]; then
		appmsg="${smpfunc}(CHECK)"
	else
		appmsg="${smpfunc}"
	fi
	if [ "${verbose}" -gt '0' ]; then
                echo "Running SMPE ${appmsg} for ${sw}"
        fi
	out=`runapply $*`
	rc=$?
	if [ ${rc} -gt 0 ] || [ ${verbose} -gt 0 ]; then
 		echo "SMP/E ${appmsg} of ${sw} returned code ${rc}. ${out}" >&2
		return ${rc}
	fi

        return ${rc}
}

debug=0
verbose=0
opts=""
while getopts ":vd" opt; do
  case ${opt} in
    d )
      debug=1
      opts="${opts} -d"
      ;;
    v )
      verbose=1
      opts="${opts} -v"
      ;;
    \?)
      if [ ${OPTARG} != "?" ]; then
	msg zbrew ${InvalidOption} E "${OPTARG}"
      fi
      syntax
      exit 4
      ;;
  esac
done
shift $(expr $OPTIND - 1 )
if [ $# -lt 2 ]; then
	msg zbrew ${TooFewParms} E "$#"
	syntax
	exit 16
fi

mydir=$(callerdir ${0})
props="${mydir}/../properties/zbrewprops.json"
zbrewpropse zbrew config "${props}"

smpfunc=$(echo ${1} | tr '[:lower:]' '[:upper:]')
check=$(echo ${2} | tr '[:lower:]' '[:upper:]') 
zosname=$(echo ${3} | tr '[:lower:]' '[:upper:]') 
fmids="$4"

out=`apply ${smpfunc} ${check} ${zosname} ${fmids}`; 

rc=$? 
if [ $rc -gt 0 ]; then
	echo "SMP/E ${smpfunc} failed with return code $rc" >&2
	echo "${out}" >&2
fi

exit $rc
