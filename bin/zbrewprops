#!/bin/sh
#set -x
if [ $# = 0 ]; then
	echo "Syntax: zbrewprops <swname> [<file>]+" >&2
	echo "  where <swname> is the software these properties are associated with" >&2
	echo "  and <file> is a JSON properties file" >&2
	echo "Each key/value pair will be evaluated, creating a variable <key> with a value <value>" >&2
	exit 16
fi
swname=$1
shift 1
for props in $*; do
if [ -f ${props} ]; then
        value=`readprops ${swname} <${props}`
	OLDIFS=$IFS; IFS="
"
	line=0
	for v in $value; do
		line=$(($line+1))
		v=`echo "$v" | awk '!/#/ { print $0; }'`
		if [ "$v" != '' ]; then
			key="${v%%=*}"
			if [ "${key}" = "${v}" ]; then
				echo "The line ${v} does not have a valid key/value pair of the form <key>=<value>. Line ignored." >&2
			else
				# Evaluate the line in a child shell. If it has errors, report them, otherwise repeat
	   			(eval "$v" 2>/dev/null >/dev/null)
				if [ $? -gt 0 ]; then
					echo "The key/value pair '$v' could not be evaluated. Please correct line ${line}" >&2
					return 16
				fi
				eval "$v"
			fi
		fi
	done
	IFS=$OLDIFS
else
	echo "Unable to find properties file ${props}" >&2
	exit 16
fi
done
